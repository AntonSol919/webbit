<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
</head>

<body>
    <form>
        <label> This is an example of a self-uploading forum. Don't like the style, comment structure, or
            desperatly want to include background music?
            Just edit this webpage and POST it to a different URL.
        </label>
        <hr>
        <!--
             You can try and upload anything by posting it to a URL.
             This returns a new quarantine url where you/the user has to vouch for the content with the private key. 
             This page is an example where someone writes a post, and the final upload contains the html & js that:

             - displays the post,
             - allows a reader to post comments,
             - loads all comments. 

             There are many alternative setups that could be built.
             With a '&hash=..' you can GET the exact page, even when a new thing is written to this path. 
             With a '&pubkey=..' you can GET the latest item vouched for by that pubkey
             With a &list / &tree you can get a list of known entries.
             
             One option is to only display comments that have been vouched for by an administrator.
             another option/extention would be to add <script src="...?pubkey=..." >.
             This makes the page 'updatable' by someone updating the script. 

             (This example.forum.editor.html is pinned in place (set in the /static dir) so a request without &hash will always return this page)
        -->
        <div>
            <label>Community</label>
            <input type="text" placeholder="community" id="community" value="webbit" />
        </div>
        <div>
            <label>Title</label>
            <input type="text" placeholder="Post title" id="title" />
        </div>
        <div>
            <label>Text</label>
            <textarea placeholder="Say something interesting" id="text"></textarea>
        </div>
        <input id="submit" type="button" value="submit" />
    </form>

    <script>
        document.querySelector("#submit").addEventListener("click", submit);
        async function submit(e) {
            // This is where the tricky part comes in. 
            // We have to submit a page that allows other people to comment. 
            // A page placed in /static/ is always served first, so you can use it for development.
            var [community, title, text] = ["#community", "#title", "#text"].map(id => document.querySelector(id).value);

            const cyrb53 = (str, seed = 0) => {
                let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
                for(let i = 0, ch; i < str.length; i++) {
                    ch = str.charCodeAt(i);
                    h1 = Math.imul(h1 ^ ch, 2654435761);
                    h2 = Math.imul(h2 ^ ch, 1597334677);
                }
                h1  = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
                h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
                h2  = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
                h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);
                
                return 4294967296 * (2097151 & h2) + (h1 >>> 0);
            };
            let post_id= cyrb53(title + text) >> 8

            // with '?data' the body is encoded into linkspace on the server side. 
            // you can use ?pkts to upload linkspace packets
            let dest = window.location.origin + `/example.forum/${community}/${post_id}/${title}.html?data`
            let body = build_post_page(community, title, text, post_id);
            fetch(dest, {
                    body,
                    method: "POST"
                })
                .then(async (response) => {
                    if (!response.ok) {
                        let body = await response.text();
                        throw Error(`Server returned ${response.status}: ${response.statusText} - ${body}`);
                    }
                    window.open(response.headers.get("location"));
                })
                .catch(e => console.warn(e) && alert(e));
            return false;
        }


        function build_post_page(community, title, text, post_id) {
            // We're going to stringify this and include it in our post page so others can comment.
            function script() {
                function main() {
                    let commentsUrl = window.location.origin + window.location.pathname + "/comments";
                    function submit() {
                        let body = document.querySelector("#text").value;
                        fetch(commentsUrl +"?data", {
                                body,
                                method: "POST"
                            })
                            .then(async (response) => {
                                if (!response.ok) {
                                    let body = await response.text();
                                    throw Error(`Server returned ${response.status}: ${response.statusText} - ${body}`);
                                }
                                window.open(response.headers.get("location") + `?back=${window.location.href}`)
                            })
                            .catch(e => console.warn(e) && alert(e));
                        return false;
                    }
                     document.querySelector("#submit").addEventListener("click", submit);
                    const range = document.createRange();

                    // Here we're loading _all_ things commented.
                    // There are a lot of alternative strategies. 
                    // e.g. You could add an 'admin' key that publishes a whitelist of accepted comments and only load those. 
                    async function load_comments(){
                        fetch(commentsUrl + "?list", {headers: { "Accept": "application/json"  }})
                        .then(async (response) => {
                            let body = await response.json();
                            let commentsEl= document.querySelector("#comments");
                            body.sort((a, b) => (BigInt(a.create) > BigInt(b.create)) ? 1 : -1 );

                            for (comment of body ){
                                let el = range.createContextualFragment("<div> loading  </div>").firstElementChild;
                                commentsEl.appendChild(el);
                                fetch(commentsUrl+"?hash="+comment.hash).then(async (response) => {
                                    el.innerHTML = await response.text() ;
                                });
                            }
                            console.log(body);
                        })
                        .catch(e => console.warn(e) && alert(e));
                    }
                    load_comments();
                }
                // Some 'whitelist' trick goes for this. 
                // At some point It would be much clearer if we'd use <script src=...?pubkey=...>.
                // That way, each script can be updated seperatly 

                // NOTE: I used '_script_' and replace it because my IDE goes bad on a plain 'script' tag 
                return `<_script_>${main.toString()} ;main();</_script_>`.replace(/_script_/g, "script");
            }
            let str = `<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head>
         </head>
         <body>
         <h1> ${title}</h1>
         <p> ${text}</p>
         <h4>${community}/${post_id}/${title}</h4>
         <textarea id="text" placeholder="Say something nice"></textarea>
<input id="submit" type="button" value="submit">
         <div id="comments"></div>
         </body>
         ${script()}
         </html>`;
            return str;
        }
    </script>
</body>

</html>
